\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{todonotes}
\usepackage{amssymb,amsmath}

\input defs.tex

\title{Computing market equilibria via convex optimization}
\author{AJ Friend \and Stephen Boyd}
\date{\today}

\begin{document}

\maketitle

\listoftodos

\section{Introduction}
we solve Fisher and Arrow-Debreu models using the formulations given in \todo{citations}. We use splitting and exploit sparsity to solve huge instances of these problems.

\subsection{Applications}
Some applications are given in Shoven and Whalley \cite{shoven1992applying}.

\section{Market definitions}
\subsection{Arrow-Debreu}

An Arrow-Debreu market has $m$ agents and $n$ goods where
agent $i$ has an initial amount $b_{ij} \in \reals_+$ of good $j$.
Agent $i$ achieves utility $u_i(x_i) \in \reals_+$ when he is is allocated a bundle of goods $x_i \in \reals^m_{+}$.
That is, he is allocated amount $x_{ij}$ of good $j$.
Generally, $u_i$ is a concave, increasing function.

Given prices $p \in \reals^n_{++}$ for each good, agent $i$ will sell his initial bundle of goods, $b_i \in \reals^n_+ $, and buy a bundle of goods $x_i$ to maximize his utility.
That is, agent $i$ solves the optimization problem
\[
\begin{array}{ll}
\mbox{maximize} & u_i(x_i) \\
\mbox{subject to} & p^T x_i \leq p^T b_i \\
& x_i \geq 0.
\end{array}
\]

The \emph{Arrow-Debreu market equilibrium problem} is to find prices $p$ and an allocation matrix $x \in \reals^{m \times n}$ (where $x_i^T$ is the $i$th row of $x$) such that the following are true:
\begin{itemize}
\item $x \geq 0$
\item $\sum_{i=1}^m x_{ij} \leq \sum_{i=1}^m b_{ij}$
\item each agent achieves his optimal utility for the given prices
\end{itemize}

The second constraint simply states that the final total amount of each good cannot exceed the initial total amount.
This model is also referred to as the Walras model \cite{walras1896elements}, or the exchange model.

Arrow and Debreu showed that equilibrium prices exist in the general case of concave utility functions \cite{arrow1954existence}. However, the proof was nonconstructive and they did not provide an algorithm to compute the equilibrium.


\subsection{Fisher}

A Fisher market has $m$ agents and $n$ goods where
agent $i$ has an initial amount of money $w_i \in \reals_+$.
The total amount of good $j$ available for purchase is given by $b_j$.
Agent $i$ achieves utility $u_i(x_i) \in \reals_+$ when he is is allocated a bundle of goods $x_i \in \mathbf{R}^m_{+}$. That is, he is allocated amount $x_{ij}$ of good $j$.
Generally, $u_i$ is a concave, increasing function.

Given prices $p \in \reals^n_{++}$ for each good, agent $i$ uses his initial money $w_i$ to buy a bundle of goods $x_i$ to maximize his utility. That is, agent $i$ solves the optimization problem
\[
\begin{array}{ll}
\mbox{maximize} & u_i(x_i) \\
\mbox{subject to} & p^T x_i \leq w_i \\
& x_i \geq 0.
\end{array}
\]

The \emph{Fisher market equilibrium problem} is to find prices $p$ and an allocation matrix $x \in \reals^{m \times n}$ (where $x_i^T$ is the $i$th row of $x$) such that the following are true:
\begin{itemize}
\item $x \geq 0$
\item $\sum_{i=1}^m x_{ij} \leq b_j$
\item each agent achieves his optimal utility for the given prices
\end{itemize}

The second constraint simply states that the final total amount of each good cannot exceed the initial available amount.



\subsection{Fisher is a special case of Arrow-Debreu}
two different transformations for this
\begin{itemize}
\item add an agent and a single good (money)
\item make the initial endowment for each agent proportional,
so each agent has a constant proportion between goods, but some agents have more total goods than others. 
\end{itemize}

\section{Definitions}
We'll list some intial definitions here which will be used throughout the remainder of the paper.
For a review of convexity and convex optimization, see
\cite{boyd2009convex}.

A utility function $u: \reals^n_+ \to \reals_+$ is \emph{homothetic} if for any $\alpha > 0$ we have that $u(x) \geq u(y)$ if and only if
$u(\alpha x) \geq u(\alpha y)$.
The utility function is \emph{monotone} if $x \geq y$ implies that $u(x) \geq u(y)$.
It is \emph{homogeneous} of degree $d$ if for any $\alpha > 0$,
$u(\alpha x) = \alpha^d u(x)$.

\begin{itemize}
\item demand function
\item aggregate excess demand function
\item (weak) gross substitutability
\item WARP?
\item walras' law
\end{itemize}



\section{Problem History}
\subsection{Formation and proof of existence}
Walras formulated his original market model in ``Elements of Pure Economics'' \cite{walras1896elements}. While he did not rigorously prove that equilibrium prices must exist, he did propose the first algorithm for computing the prices through his \emph{tatonnement} price updating scheme.

Arrow and Debreu \cite{arrow1954existence} were the first to show that equilibrium prices exist in a setting with concave utilities. The proof relies on a fixed point theorem and is thus non-constructive. As a result, it offers no obvious avenues for actually computing the equilibrium.

Arrow, Block and Hurwicz \cite{arrow1959stability} showed that for markets satisfying weak gross substitutability, a continuous-time tatonnement process would always converge to equilibrium prices.

\todo{would be nice to give the reader an idea at this point of what is tractable and what isn't. np-hard, disconnected solution sets...}

\subsection{Fisher case}
For the case of Fisher markets,
Eisenberg and Gale \cite{eisenberg1959consensus, gale1960theory} and
Eisenberg \cite{eisenberg1961aggregation} gave a convex optimization formulation for computing equilibrium first for linear utility functions, and then for the more general case of concave functions which are homogeneous with degree 1.
Jain et al. \cite{jain2005market} generalized this model to handle homothetic and quasi-concave utilities.
Examples of these utilities were introduced by Friedman
\cite{friedman1973concavity}.
\todo{rephrase}However, it is unclear if the transformation given in \cite{jain2005market} is of practical use in a convex optimization setting.

It is important to note that the Fisher model is a special case of the Arrow-Debreu model. However, the Fisher case is strictly easier than the Arrow-Debreu case. For example, Codenotti et al.\ \cite{codenotti2006leontief} show that the Arrow-Debreu problem with Leontief utilities is NP-hard, while the Fisher problem with Leontief utilities remains a convex program.

\subsection{Initial algorithms}

Scarf and others \cite{scarf2008applied,eaves1972homotopies,kuhn1968simplicial}
expanded on the fixed-point existence theorems to produce algorithms for computing equilibria based on traversing a decomposed price simplex. However, these algorithms have exponential running time in the worst case. Scarf's algorithm is also described in the text \cite{shoven1992applying}.

Smale \cite{smale1976convergent, smale1976exchange} developed Newton-based methods which are guaranteed to converge, but with no running time guarantee.

The convergent continuous-time tatonnement process of Arrow, Block and Hurwicz \cite{arrow1959stability} was extended to a discrete-time (and thus computationally implementable) version by Codenotti, McCune and Varadarajan \cite{codenotti2005marketExcess}, who were able to show that it converges for WGS markets in polynomial time.

Negishi \cite{negishi1960welfare} shows that the exchange model equilibrium is given by a convex program whose objective is a linear combination of the utility functions, but with unknown weights. Thus, the computational task is to find these positive weights. A process similar to tatonnement can be performed in the space of weights and is shown by Mantel \cite{mantel1971welfare} to be convergent under certain conditions.

\subsection{Cutting plane methods}
While working on tatonnement, Arrow, Block and Hurwicz \cite{arrow1959stability} proved a separating hyperplane lemma which would form the basis of much future work. The lemma showed that for any given (non-equilibrium) prices, a function called the aggregate excess demand provided a cutting plane in the price simplex, identifying which half-space contained the equilibrium prices.
This cutting plane result held for a class of utility functions satisfying weak gross substitutability.

An immediate corollary of this result is that for markets with the GS property, the set of equilibrium prices is convex. \todo{specifically, positive homogeneous, GS, and Walras' law} \todo{later generalized to weak GS}
However, even for some natural homogeneous (but not GS) functions, the Arrow-Debreu equilibrium may be disconnected (and thus certainly not convex) \cite{gjerstad1996multiple}. Also, \cite[p.~608]{mas1995microeconomic} shows that WGS and WARP Arrow-Debreu markets have convex equilibria.

This line of worked was continued by Polterovich, Spivak, Primak, Newman, and Nenakov \cite{nenakov1983algorithm,newman1992complexity,primak1984algorithm,primak1993converging}.

Later, a polynomial time algorithm was given by Codenotti, Pemmaraju and Varadarajan \cite{codenotti2005polynomial}. This result held for markets whose aggregate excess demand function satisfied weak gross substitutability. It combined the cutting plane result with an ellipsoid method to produce a polynomial time algorithm. This is one of the most general settings for the exchange problem and includes many utility functions. This result was later extended by McCune \cite{mccune2007extending} to markets with multi-valued aggregate excess demand functions, which includes linear utility functions.

\subsection{Convex formulations}
Even though we have a proof that Arrow-Debreu equilibria are given by a convex set, these problems still may not be easily solved with convex optimization.
The computational thread that we will follow in this paper started when Jain \cite{jain2007polynomial} rediscovered a convex formulation originally stated by Nenakov and Primak \cite{nenakov1983algorithm}. This formulation was later extended by Chen, Ye and Zhang \cite{chen2007note,chen2010equilibrium} to include some non-homogeneous utility functions. The set of functions covered by this formulation is more restrictive than the WGS setting of the previous section. \todo{how does this fit into the WGS framework?}

Again, we will mention that even for some natural homogeneous (but not GS) functions, the Arrow-Debreu equilibrium may be disconnected (and thus certainly not convex) \cite{gjerstad1996multiple}.
Also, is shown in \cite{codenotti2006leontief} that the Arrow-Debreu problem with Leontief utilities is NP-hard.
We can see that the computability of equilibrium very much depends on the properties of the utility functions.


\subsection{Other approaches}
Codenotti et al.\ \cite{codenotti2005market,codenotti2005marketCES} form a convex program for exchange economies with CES utility functions that do not satisfy WGS.

\subsection{Models with production}
Arrow-Debreu models which include the production of goods are studied in \cite{garg2014computability,jain2005market,codenotti2005marketExcess}, with an overview in \cite[Chapters~5--6]{nisan2007algorithmic}. \todo{there are many other papers to include}

\subsection{References}
Good surveys of the literature can be found in Chapters 5 and 6 of \cite{nisan2007algorithmic} and McCune's 2009 thesis \cite{mccune2009algorithmic}.

The market equilibrium problem, including existence proofs, formulations of central concepts such as demand functions, Walras' Law, and the cutting plane property, is also covered in many popular economics texts, such as \cite{varian1992microeconomic, mas1995microeconomic, luenberger1995microeconomic, kreps1990course}.

Experimental results comparing various algorithms can be found in Codenotti et al.\ \cite{codenotti2008experimental}. They compare discrete versions of tatonnement and welfare adjustment, as well as convex formulations for some specific markets.


\section{Convex optimization formulations}


\subsection{Fisher}

The Fisher equilibrium problem is solved by the following convex program when the utility functions are concave and homogeneous of degree 1 \cite{eisenberg1959consensus, gale1960theory, eisenberg1961aggregation}.
See \cite[Section~6.2]{nisan2007algorithmic} for the optimality conditions and proof:

\[
\begin{array}{ll}
\mbox{maximize} & \sum_{i=1}^m w_i \log u_i(x_i) \\
\mbox{subject to} & \sum_{i=1}^m x_{ij} \leq b_j, \quad \forall j\\
& x \geq 0.
\end{array}
\]

Here, the prices appear as dual variables.

\subsection{Arrow-Debreu}
It can be shown that a market equilibrium always exists and can be found by solving the problem

\[
\begin{array}{ll}
\mbox{find} & x, p \\
\mbox{subject to} & \nabla u_i(x_i)^T x_i \geq  \nabla_j u_i(x_i) \sum_k b_{ik} \frac{p_k}{p_j}, \forall i,j\\
& \sum_i x_{ij} \leq \sum_i b_{ij}, \forall j\\
& x_{ij} \geq 0, p_j \geq 0.
\end{array}
\]


The above problem is not convex but can be easily transformed by a simple change of variables. Specifically, let $p_j = \exp(\phi_j)$.
Then the problem becomes

\[
\begin{array}{ll}
\mbox{find} & x, \phi \\
\mbox{subject to} & \nabla u_i(x_i)^T x_i \geq  \nabla_j u_i(x_i) \sum_k b_{ik} e^{\phi_k - \phi_j}, \forall i,j\\
& \sum_i x_{ij} \leq \sum_i b_{ij}, \forall j\\
& x_{ij} \geq 0.
\end{array}
\]

This is a convex feasibility problem and can be solved in a variety of ways.
Throughout the remainder, we'll use the following formulation:

\[
\begin{array}{ll}
\mbox{find} & x, \phi \\
\mbox{subject to} & \log(\nabla u_i(x_i)^T x_i) + \phi_j \geq  \log(\nabla_j u_i(x_i)) +  \log(\sum_k b_{ik} e^{\phi_k}), \forall i,j\\
& \sum_i x_{ij} \leq \sum_i b_{ij}, \forall j\\
& x_{ij} \geq 0.
\end{array}
\]

Note that the first constraint need only be explicitly formed when $\nabla_j u_i(x_i) > 0$, and we only need to include terms in the sum in
$\log(\sum_k b_{ik} e^{\phi_k})$ when $b_{ik} > 0$. These ideas will be used later when we exploit sparsity to solve these problems efficiently.

\paragraph{Convexity}
We see that the convexity of this formulation depends on the agents' utility functions. The formulation is convex if
\begin{itemize}
\item $\log(\nabla u_i(x_i)^T x_i)$ is concave, and
\item $\log(\nabla_j u_i(x_i))$ is convex.
\end{itemize}
Note that, for homogeneous functions, Euler's identity gives that
\[
\nabla u_i(x_i)^T x_i = u_i(x_i).
\]
\todo[inline]{Some special care needs to be taken here for nonsmooth functions.}

\section{Utility functions}
For each utility function, we'll list if it works in the Fisher setting, the convex formulation given by \cite{chen2010equilibrium}, or the cutting plane setting. List if homogeneous, GS or weak GS, and if demand is a function or a relation. if it satisfies walras' law, etc. Also, show how functions are representable in a DCP system.

\subsection{Linear}
\[
u(x) = a^T x
\]
\paragraph{Fisher}
This utility works in the Fisher setting, as it is homogeneous of degree 1.
\paragraph{Arrow-Debreu}
This utility works in the Arrow-Debreu setting since
\[
\log(\nabla u(x)^T x) = \log(a^T x)
\]
is concave and
\[
\log(\nabla_j u(x)) = \log(a_j)
\]
is constant, therefore convex.

\paragraph{Cutting plane}
\todo[inline]{satisfies WGS, is multi-valued, WARP}

\subsection{Constant elasticity of substitution (CES)}
CES constant elasticity of substitution have form
\[
u(x) = \left(\sum_{j=1}^n a_j x_j^\rho \right)^{1/\rho},
\]
where $-\infty < \rho \leq 1, \rho \neq 0$.
CES functions are concave for any of these values of $\rho$.
May not be tractable when $\rho < -1$.
\todo{note special cases: linear, cobbdouglas, leonteif}

\paragraph{Fisher}
This utility works in the Fisher setting, as it is concave and homogeneous of degree 1.

\paragraph{Arrow-Debreu}
This function does not work in the Arrow-Debreu setting because, since it is homogeneous,
\[
\log(\nabla u(x)^T x) = \log(u(x))
\]
is concave.
Also,
\begin{align*}
\log(\nabla_j u(x)) & = 
\log\left( \left(\sum_{j=1}^n a_j x_j^\rho \right)^{\frac{1}{\rho}-1} a_j x_j^{\rho-1}\right)\\
& = \left(\frac{1}{\rho}-1\right)\log\left( \sum_{j=1}^n a_j x_j^\rho \right) + \log a_j +  \log \left(x_j^{\rho-1}\right),
\end{align*}
which is concave, but not convex, as we'd need it to be.

The expression above becomes convex when we move both logs to the same side and cancel terms. \todo[inline]{update}

\paragraph{Cutting plane} I think it is GS

\subsection{Nested CES}
see \cite{shoven1992applying} for examples and applications.  \todo{when is CES convex? nested is convex?}

\subsection{Cobb-Douglas}
\[
u(x) = \prod_{j=1}^{n} x_j^{a_j},
\]
where $\sum_j a_j = 1$.

\subsection{Leontief}
\[
u(x) = \min_j a_j x_j
\]

\paragraph{Fisher}
Works for Fisher as it is homogeneous and concave.

\paragraph{Arrow-Debreu}
Does not work for Arrow-Debreu.

\subsection{Piecewise linear concave functions}
\[
u(x) = \min_k\lbrace a^{kT}x \rbrace,\quad a^k \geq 0
\]
leonteif is a special case. why is it no WGS?

\subsection{Fractional power}
 \[
 u(x) = \sum_{j=1}^n a_j (x_j+ b_j)^{d_j},
 \]
 where $a_j, b_j \geq 0$ and $0 \leq d_j \leq 1$.
 Note that these need not be homothetic. Consider $u(x,y) = \sqrt{x} + y$.

\subsection{Logarithmic}
\[
u(x) = \sum_{j=1}^n a_j \log(x_j+ b_j),
\]
where $a_j, b_j \geq 0$.  Note that these need not be homothetic.

\subsection{Other examples}
\begin{itemize}
\item 'VES' functions  $u(x) = \sum_{j=1}^{n} a_j x_j^{\rho_j}$ for $0 < \rho_j < 1$
\item $u(x) = \min(x_1,x_2) + \min(x_3,x_4)$
\end{itemize}




\subsection{Arrow-Debreu}
things that work are:
\begin{itemize}
\item linear
\item CES with $\rho > 0$ (Codenotti may be able to write another program that handles $\rho < 0$.)
\item Cobb-Douglas
\end{itemize}
what work, what are representable
\begin{itemize}
\item complicated CES functions, nested, etc..
\item rational powers represented through SOCP
\end{itemize}

\section{Solution methods}

\subsection{CVXPY and SCS}
\subsection{Exploiting sparsity}
\subsection{Splitting}
handle splitting over agents, and also splitting over constraints. over agents needs no multiplication of variables, splitting over constraints does. find a prox regime that handles both easily.

inspect dual variables to guarantee some allocations are zero? this allows us to throw them out of the problem as we iterate.

\subsection{Cutting plane}
\subsection{Approximations?}
can i approximate the exponential cone to do an approximate prox evaluation
at each step, allowing for SOCP solvers that can't handle exponential cones?

what if we approximate everything with a quadratic around the current iterate for an approximate projection? subset or superset of actual agent cutting set? does this simplification make updates with an analytic form, allowing for very fast iteration?

\section{Huge, distributed models}
\missingfigure{Add a yet to be made figure here.}

\newpage
\bibliographystyle{alpha}
\bibliography{bibliography.bib}

\end{document}


